import jwt
import time
from flask import Flask
from flask_mail import Mail
from flask import request, session, redirect, url_for, render_template, flash
from flask_sqlalchemy import SQLAlchemy

import funcs
import i18n
import send_email


app = Flask(__name__, static_url_path="", static_folder="../frontend")
app.template_folder = "../frontend"
app.secret_key = b'#$somestrangesupersecrethashautogenerated!/___'

INSERT = 0
UPDATE = 1
SEARCH = 2
DELETE = 3

app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://admin:Admin123.@localhost/tasa'
app.config['MAIL_SERVER'] = 'smtp.gmail.com'
app.config['MAIL_PORT'] = 465
app.config['MAIL_USE_SSL'] = True
app.config['MAIL_USERNAME'] = 'digitaltasa@gmail.com'
app.config['MAIL_PASSWORD'] = 'Abc.123@?'
mail = Mail()
app.app_context().push()
db = SQLAlchemy(app)
mail.init_app(app)


@app.route('/ping', methods=['GET', 'POST'])
def ping():
    return 'Hello, World!'


@app.route('/')
def index():
    if 'user' not in session:
        return render_template('/index.html')
    return render_template("main.html", user=session["user"])
    # return "Welcome: " + session["user"]


@app.route('/saveUser', methods=['POST'])
def saveUser():
    is_logged = funcs.validateSession(session)
    if is_logged == -1:
        return "<script> location.href=\'/index.html\' </script>"
    dict_form = funcs.parseForm(request.form, funcs.saveUser, INSERT)
    if dict_form == -1:
        print(dict_form)
        return "<script> alert('El usuario ya existe en el sistema'); location.href=\'/\'; </script>"
    return "<script> alert('"+dict_form+"'); location.href=\'/\'; </script>"


@app.route('/updateUser', methods=['POST'])
def updateUser():
    if funcs.validateSession(session) == -1:
        return "Please Login"
    # Parse Form
    result = funcs.parseForm(request.form, funcs.updateUser, UPDATE)
    if result == -1:
        return "Some Error Happend, Please Contact the Admin"
    return "<script> alert('"+result+"'); location.href=\'/\'; </script>"


@app.route('/property', methods=['GET', 'POST'])
def propertyList():
    if request.method == "GET":
        property_id = request.args.get("id")
        property_dict = funcs.searchPropertyById(property_id)
        return render_template("property.html", property_dict=property_dict[0])


@app.route("/property_menu", methods=['GET'])
def printPropertyMenu():
    propertyList = funcs.getPropertiesName()
    propertyLand = funcs.getLandByProperty()
    return render_template("property_menu.html", property_list=propertyList, property_land=propertyLand)


# TODO: Add Documentation of the endpoints of the api
# TODO: Create i18n for responses and headers
@app.route('/userList', methods=['GET', 'POST'])
def userList():
    if funcs.validateSession(session) == -1:
        return "Please Login"
    response = {}
    if request.method == "GET":
        user = request.args.get("user")
        response = funcs.userList(user)
        return render_template("user.html", user=response[0], i18n=i18n.i18n)
    if request.method == "POST":
        response = funcs.userList()
    return render_template("table.html", user_list=response)


@app.route('/user', methods=["GET"])
def showUser():
    if request.method == "GET":
        user = request.args.get("user")
        response = funcs.userList(user)
        return render_template("show_user.html", user=response[0], i18n=i18n.i18n)


# TODO: Validate LOGIN
@app.route('/save_property', methods=['POST'])
def save_property():
    if funcs.validateSession(session) == -1:
        return "Please Login"

    response = funcs.parseForm(request.form, funcs.saveProperty, INSERT)
    return response


@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == "GET":
        return render_template('/index.html')
    else:
        dict_form = funcs.parseForm(request.form, funcs.searchUser, SEARCH)
        if dict_form != -1:
            session['user'] = dict_form["email"]
            return redirect(url_for('index'))

        flash('Usuario no se encuentra en el sistema')
        return render_template('/index.html')

@app.route('/reset_password', methods=['GET', 'POST'])
def reset_password():
    if request.method == "GET":
        return render_template('/reset_password.html')


    if request.method == "POST":
        dict_form = funcs.parseForm(request.form, funcs.searchUserByEmail, SEARCH)
        if dict_form != -1:
            email = dict_form["user"]
            token = get_reset_token(email)
            recover_url = url_for(
            'reset_with_token',
            token=token,
            _external=True)
            send_email.welcome_mail(email, recover_url)
            flash('Hemos enviado un link al correo registrado')
            return render_template('/index.html')
        
        flash('Este correo no se encuentra registrado')
        return render_template('/reset_password.html')

def get_reset_token(self, expires=5000):
    return jwt.encode({'reset_password': self,
                           'exp':    time.time() + expires},
                           key=app.secret_key)

@app.route('/reset/<token>', methods=["GET", "POST"])
def reset_with_token(token):
    if request.method == "GET":
        try:
            username = jwt.decode(token,
                key=app.secret_key)['reset_password']
        except Exception as e:
            print(e)
            return

        user = {"user":username}
        return render_template('email/reset_with_token.html', token=token)
    if request.method == "POST":
        new_password = request.form['password']
        token = request.form['token']
        email = jwt.decode(token,
                key=app.secret_key)['reset_password']

        result = funcs.updateUserPasswordByEmail(email, new_password)
        flash('Se ha restaurado la contrase√±a')
        return redirect(url_for('index'))


@app.route('/userSelect', methods=["GET"])
def printSelect():
    html = funcs.listOfUsers()
    return html


@app.route('/logout')
def logout():
    # remove the username from the session if it's there
    session.pop('user', None)
    return redirect(url_for('login'))
